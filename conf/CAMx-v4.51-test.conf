#!/usr/bin/env bash
#
# Runner script for CAMx 4.42/4.51 - Configuration. 
# See http://people.web.psi.ch/oderbolz/CAMxRunner
# 
# Leave the next line intact, it is used for change detection
# Version: $Id$ 
#
# Written by Daniel C. Oderbolz (CAMxRunner@psi.ch),
# Released under the Creative Commons "Attribution-Share Alike 2.5 Switzerland"
# License, (http://creativecommons.org/licenses/by-sa/2.5/ch/deed.en)
################################################################################
#
# All Variables (except system variables like OMP*) names start with CXR_
# Output File names end with OUTPUT_FILE
# Input File names end with INPUT_FILE
#
# Arrays of files are called OUTPUT_ARR_FILES AND INPUT_ARR_FILES
#
# Directories with _DIR
# Output directories with OUTPUT_DIR
# Executables with _EXEC
#
# Strings which are used as Floating point numbers, but are integer, need a trailing .
#
# Arrays must have an index 0 with a Dummy entry, we work in Fortran Land here.
#
# Also, entries in arrays which contain spaces must be protected by
# single (') quotes, because arrays are exported as space separated list

################################################################################
# Notification options
################################################################################
CXR_MAILADDR=CAMxRunner@psi.ch
CXR_SMSNR=0765888275
CXR_SMSPROVIDER=sms.switch.ch
CXR_SMSADDR=${CXR_SMSNR}@${CXR_SMSPROVIDER}

#If this Variable is true, SMS will be sent
CXR_SEND_SMS=false

################################################################################
# Timespan of simulation
################################################################################

# The Start of the simulation in YYYY-MM-DD notation
CXR_START_DATE=2007-01-01

# The Stop of the simulation in YYYY-MM-DD notation
CXR_STOP_DATE=2007-01-01

################################################################################
# Labels
################################################################################
CXR_MET_PROJECT=uw3
CXR_MET_SCENARIO=s151

CXR_EMMISS_PROJECT=${CXR_MET_PROJECT}
CXR_EMMISS_SCENARIO=sem050
CXR_CAMX_PERIOD=winter07
CXR_CAMX_SCENARIO=${CXR_MET_SCENARIO}-prebiotest	
CXR_CAMX_CUSTOMER=bafu3

CXR_STATION_LABEL=NABEL

################################################################################
# Directories
################################################################################

################################################################################
# Directories (only those that differ from base)
################################################################################

# Input preparation directories
CXR_EMISSION_SOURCE_DIR=/afs/psi.ch/intranet/LAC/oderbolz/emiss/emisscamx


################################################################################
# CAMxRunner specific settings
################################################################################


################################################################################
# If you want to disable modules of the CAMxRunner, do it here
################################################################################

# This string contains the space-separated module names of
# unwanted daily preprocessors like "create_emissions"
# If "${CXR_SKIP_ALL}" is given, all daily preprocessors are skipped

CXR_DISABLED_DAILY_PREPROC=""

# This string contains the space-separated  module names of
# unwanted one-time preprocessors.
# If "${CXR_SKIP_ALL}" is given, all one-time preprocessors are skipped

CXR_DISABLED_ONCE_PREPROC=""

# This string contains the space-separated module names of
# unwanted daily postprocessors like "prepare_output_dir convert_output"
# If "${CXR_SKIP_ALL}" is given, all daily postprocessors are skipped
	
CXR_DISABLED_DAILY_POSTPROC="avgdif"

# This string contains the space-separated module names of
# unwanted one-time postprocessors.
# If "${CXR_SKIP_ALL}" is given, all one-time postprocessors are skipped

export  CXR_DISABLED_ONCE_POSTPROC=""

################################################################################
# Preprocessors
################################################################################	

################################################################################
# Postprocessors
################################################################################	

################################################################################
# CAMxRunner Internal stuff
################################################################################

# Accepted error threshold before stop. (-1 turns off this check)
CXR_ERROR_THRESHOLD=50

################################################################################
# Rules for filenames (See http://people.web.psi.ch/oderbolz/CAMxRunner#FileRules)
#
# There are more filerules in the Probing sections of this file
#
# These ABSOLUTELY need 'single quotes' around them, otherwise the shell expands them here!
################################################################################

################## Grid independent ############################################

# Input Preparation ############################################################


# Input ########################################################################

CXR_PHOTOLYIS_RATES_FILE_RULE='${CXR_INPUT_DIR}/tuv_${CXR_CAMX_CUSTOMER}_${CXR_YEAR_S}_${CXR_WOY}.out'
CXR_INITIAL_CONDITIONS_FILE_RULE='${CXR_INPUT_DIR}/ic_${CXR_CAMX_CUSTOMER}_moz.bin'
CXR_BOUNDARY_CONDITIONS_FILE_RULE='${CXR_INPUT_DIR}/bc_${CXR_CAMX_CUSTOMER}_moz_${CXR_YEAR_S}${CXR_MONTH}${CXR_DAY}.bin'
CXR_TOP_CONCENTRATIONS_FILE_RULE='${CXR_INPUT_DIR}/topconc_${CXR_CAMX_CUSTOMER}${CXR_YEAR_S}.${CXR_ASC_EXT}'
CXR_ALBEDO_HAZE_OZONE_FILE_RULE='${CXR_INPUT_DIR}/ahomap_${CXR_CAMX_CUSTOMER}_3grids_${CXR_YEAR_S}_${CXR_WOY}.out'

CXR_POINT_SOURCES_FILE_RULE=''

CXR_MASTER_GRID_RESTART_FILE_RULE='${CXR_OUTPUT_DIR}/${CXR_RUN}.${CXR_DATE_RAW_YESTERDAY}.inst'
CXR_NESTED_GRID_RESTART_FILE_RULE='${CXR_OUTPUT_DIR}/${CXR_RUN}.${CXR_DATE_RAW_YESTERDAY}.finst'

# More restart rules in the probing sections later

CXR_PIG_RESTART_FILE_RULE=''

CXR_ROOT_OUTPUT_FILE_RULE='${CXR_OUTPUT_DIR}/${CXR_RUN}.${CXR_DATE_RAW}'

# File Roots for probing
CXR_PA_ROOT_OUTPUT_FILE_RULE='$CXR_PA_OUTPUT_DIR/${CXR_RUN}.${CXR_YEAR_S}${CXR_MONTH}${CXR_DAY}'

CXR_DDM_ROOT_OUTPUT_FILE_RULE='$CXR_DDM_OUTPUT_DIR/${CXR_RUN}.${CXR_YEAR_S}${CXR_MONTH}${CXR_DAY}'
CXR_RT_ROOT_OUTPUT_FILE_RULE='$CXR_RT_OUTPUT_DIR/${CXR_RUN}.${CXR_YEAR_S}${CXR_MONTH}${CXR_DAY}'
CXR_SA_ROOT_OUTPUT_FILE_RULE='$CXR_SA_OUTPUT_DIR/${CXR_RUN}.${CXR_YEAR_S}${CXR_MONTH}${CXR_DAY}'

# These are used 
#	* to prevent overwriting of existing files 
#	* the creation of the aqmfad directory
#	* to convert the binary output files

CXR_DIAG_FILE_RULE='${CXR_ROOT_OUTPUT}.diag'
CXR_FINST_FILE_RULE='${CXR_ROOT_OUTPUT}.finst'
CXR_INST_FILE_RULE='${CXR_ROOT_OUTPUT}.inst'
CXR_MASS_FILE_RULE='${CXR_ROOT_OUTPUT}.mass'
CXR_OUT_FILE_RULE='${CXR_ROOT_OUTPUT}.out'

################## NABEL (Station dependent)#####################################

# The local variable $station will be replaced by the actual name of the station in question
CXR_STATION_FILE_RULE='${CXR_STATION_OUTPUT_DIR}/${CXR_RUN}.${CXR_YEAR_S}${CXR_MONTH}${CXR_DAY}_${station}.dat'

# This is the name of the cumulated file
CXR_CUMULATIVE_STATION_FILE_RULE='${CXR_STATION_OUTPUT_DIR}/${CXR_RUN}.${CXR_YEAR_S}${CXR_MONTH}_${station}-complete.dat'

################## Grid spcecific ##############################################

# These NEED the variable ${CXR_IGRID} somewhere (the grid number)

# Input Preparation ############################################################

# Emission (classical)
CXR_EMISSION_ASC_FILE_RULE='${CXR_EMISSION_SOURCE_DIR}/${CXR_DATE_RAW}/${CXR_EMMISS_SCENARIO}/camx_emiss_domain${CXR_IGRID}_${CXR_MET_PROJECT}_${CXR_EMMISS_SCENARIO}_${CXR_DATE_RAW}.asc'

# Input ########################################################################

#Landuse
CXR_LANDUSE_FILE_RULE='${CXR_INPUT_DIR}/terrain_domain${CXR_IGRID}_${CXR_MET_PROJECT}_lucamx.bin'

# Pressure
CXR_PRESSURE_FILE_RULE='${CXR_METEO_DIR}/${CXR_DATE_RAW}/${CXR_MET_SCENARIO}/camx_zp_domain${CXR_IGRID}_${CXR_MET_PROJECT}_${CXR_MET_SCENARIO}:${CXR_YEAR}-${CXR_MONTH}-${CXR_DAY_METEO}'

# Wind
CXR_WIND_FILE_RULE='${CXR_METEO_DIR}/${CXR_DATE_RAW}/${CXR_MET_SCENARIO}/camx_uv_domain${CXR_IGRID}_${CXR_MET_PROJECT}_${CXR_MET_SCENARIO}:${CXR_YEAR}-${CXR_MONTH}-${CXR_DAY_METEO}'

# Temperature
CXR_TEMPERATURE_FILE_RULE='${CXR_METEO_DIR}/${CXR_DATE_RAW}/${CXR_MET_SCENARIO}/camx_tp_domain${CXR_IGRID}_${CXR_MET_PROJECT}_${CXR_MET_SCENARIO}:${CXR_YEAR}-${CXR_MONTH}-${CXR_DAY_METEO}'

# Vapor
CXR_VAPOR_FILE_RULE='${CXR_METEO_DIR}/${CXR_DATE_RAW}/${CXR_MET_SCENARIO}/camx_qa_domain${CXR_IGRID}_${CXR_MET_PROJECT}_${CXR_MET_SCENARIO}:${CXR_YEAR}-${CXR_MONTH}-${CXR_DAY_METEO}'

# Cloud
CXR_CLOUD_FILE_RULE='${CXR_METEO_DIR}/${CXR_DATE_RAW}/${CXR_MET_SCENARIO}/camx_cr_domain${CXR_IGRID}_${CXR_MET_PROJECT}_${CXR_MET_SCENARIO}:${CXR_YEAR}-${CXR_MONTH}-${CXR_DAY_METEO}'

# Vertical K
CXR_K_FILE_RULE='${CXR_METEO_DIR}/${CXR_DATE_RAW}/${CXR_MET_SCENARIO}/camx_kv_CMAQ_domain${CXR_IGRID}_${CXR_MET_PROJECT}_${CXR_MET_SCENARIO}:${CXR_YEAR}-${CXR_MONTH}-${CXR_DAY_METEO}'
 
# Emissions
CXR_EMISSION_FILE_RULE='${CXR_EMISSION_DIR}/camx_emiss_domain${CXR_IGRID}_${CXR_EMMISS_PROJECT}_${CXR_EMMISS_SCENARIO}_${CXR_DATE_RAW}.bin'


# Output #######################################################################

#Deposition file
CXR_DEPN_FILE_RULE='${CXR_ROOT_OUTPUT}.depn.grd0${CXR_IGRID}'

CXR_AVG_FILE_RULE='${CXR_ROOT_OUTPUT}.avrg.grd0${CXR_IGRID}'  

# We create the ASCII version of thefiles in the aqmfad directory      
# All rules start with the CXR_AQMFAD_OUTPUT_DIR and end with ${CXR_ASC_EXT}
CXR_AVG_ASC_FILE_RULE='${CXR_AQMFAD_OUTPUT_DIR}/${CXR_RUN}.${CXR_DATE_RAW}.avrg.grd0${CXR_IGRID}.${CXR_ASC_EXT}'

# Landuse ASCII File is provided by MM5, we will convert it to binary
CXR_LANDUSE_ASC_FILE_RULE='${CXR_LANDUSE_DIR}/terrain_domain${CXR_IGRID}_${CXR_MET_PROJECT}_lucamx.asce'

# Terrain elevation for aqmfad
CXR_TERRAIN_ASC_FILE_RULE='${CXR_LANDUSE_DIR}/terrain_domain${CXR_IGRID}_${CXR_MET_PROJECT}_terrcamx.asce'

CXR_PRESSURE_ASC_FILE_RULE='${CXR_AQMFAD_OUTPUT_DIR}/camx_zp_domain${CXR_IGRID}_${CXR_MET_PROJECT}_${CXR_MET_SCENARIO}:${CXR_YEAR}-${CXR_MONTH}-${CXR_DAY_METEO}.${CXR_ASC_EXT}'
CXR_WIND_ASC_FILE_RULE='${CXR_AQMFAD_OUTPUT_DIR}/camx_uv_domain${CXR_IGRID}_${CXR_MET_PROJECT}_${CXR_MET_SCENARIO}:${CXR_YEAR}-${CXR_MONTH}-${CXR_DAY_METEO}.${CXR_ASC_EXT}'
CXR_TEMPERATURE_ASC_FILE_RULE='${CXR_AQMFAD_OUTPUT_DIR}/camx_tp_domain${CXR_IGRID}_${CXR_MET_PROJECT}_${CXR_MET_SCENARIO}:${CXR_YEAR}-${CXR_MONTH}-${CXR_DAY_METEO}.${CXR_ASC_EXT}'
CXR_VAPOR_ASC_FILE_RULE='${CXR_AQMFAD_OUTPUT_DIR}/camx_qa_domain${CXR_IGRID}_${CXR_MET_PROJECT}_${CXR_MET_SCENARIO}:${CXR_YEAR}-${CXR_MONTH}-${CXR_DAY_METEO}.${CXR_ASC_EXT}'
CXR_CLOUD_ASC_FILE_RULE='${CXR_AQMFAD_OUTPUT_DIR}/camx_cr_domain${CXR_IGRID}_${CXR_MET_PROJECT}_${CXR_MET_SCENARIO}:${CXR_YEAR}-${CXR_MONTH}-${CXR_DAY_METEO}.${CXR_ASC_EXT}'
CXR_K_ASC_FILE_RULE='${CXR_AQMFAD_OUTPUT_DIR}/camx_kv_CMAQ_domain${CXR_IGRID}_${CXR_MET_PROJECT}_${CXR_MET_SCENARIO}:${CXR_YEAR}-${CXR_MONTH}-${CXR_DAY_METEO}.${CXR_ASC_EXT}'		

# Aqmfad options
# This is treated like an array
# CXR_RUN_AQMFAD_ON_GRID="1 2 3"

CXR_RUN_AQMFAD_ON_GRID="3"

################################################################################
# Grid definition
################################################################################

################################################################################
# Model options (Solver etc.)
################################################################################
CXR_DIAGNOSTIC_ERROR_CHECK=false    # True=will stop before 1st timestep
CXR_ADVECTION_SOLVER=PPM      # (PPM,BOTT)
CXR_CHEMISTRY_SOLVER=CMC      # (CMC,IEH,LSODE)

CXR_PROBING_TOOL=None     # (None,OSAT,PSAT,GOAT,APCA,DDM,PA,RTRAC)
CXR_CHEMISTRY=true
CXR_DRY_DEPOSITION=true
CXR_WET_DEPOSITION=true
CXR_STAGGERED_WINDS=true
CXR_GRIDDED_EMISSIONS=true
CXR_POINT_EMISSIONS=false
CXR_IGNORE_EMISSION_DATES=true

# Generate PIG relevant code
CXR_PLUME_IN_GRID=false
CXR_PIG_SUBMODEL=None     # (None,GREASD,IRON)


################################################################################
################################################################################
# Changes below this Comment are rather unusual
################################################################################
################################################################################

################################################################################
# Chemical species
################################################################################

# First unset array
unset CXR_OUTPUT_SPECIES_NAMES

# Entry 0 is a dummy, we want our arrays to start with index 1
CXR_OUTPUT_SPECIES_NAMES[0]=-
CXR_OUTPUT_SPECIES_NAMES[1]=NO
CXR_OUTPUT_SPECIES_NAMES[2]=NO2
CXR_OUTPUT_SPECIES_NAMES[3]=O3
CXR_OUTPUT_SPECIES_NAMES[4]=TOL
CXR_OUTPUT_SPECIES_NAMES[5]=XYL
CXR_OUTPUT_SPECIES_NAMES[6]=FORM
CXR_OUTPUT_SPECIES_NAMES[7]=PAN
CXR_OUTPUT_SPECIES_NAMES[8]=CO
CXR_OUTPUT_SPECIES_NAMES[9]=HONO
CXR_OUTPUT_SPECIES_NAMES[10]=HNO3
CXR_OUTPUT_SPECIES_NAMES[11]=H2O2
CXR_OUTPUT_SPECIES_NAMES[12]=ISOP
CXR_OUTPUT_SPECIES_NAMES[13]=PNA
CXR_OUTPUT_SPECIES_NAMES[14]=SO2
CXR_OUTPUT_SPECIES_NAMES[15]=NH3
CXR_OUTPUT_SPECIES_NAMES[16]=PH2O
CXR_OUTPUT_SPECIES_NAMES[17]=PNO3
CXR_OUTPUT_SPECIES_NAMES[18]=PSO4
CXR_OUTPUT_SPECIES_NAMES[19]=PNH4
CXR_OUTPUT_SPECIES_NAMES[20]=POA
CXR_OUTPUT_SPECIES_NAMES[21]=PEC
CXR_OUTPUT_SPECIES_NAMES[22]=SOA1
CXR_OUTPUT_SPECIES_NAMES[23]=SOA2
CXR_OUTPUT_SPECIES_NAMES[24]=SOA3
CXR_OUTPUT_SPECIES_NAMES[25]=SOA4
CXR_OUTPUT_SPECIES_NAMES[26]=SOA5
CXR_OUTPUT_SPECIES_NAMES[27]=SOA6
CXR_OUTPUT_SPECIES_NAMES[28]=SOA7

# Automatically count # species (subtract 1 for dummy)
CXR_NUMBER_OF_OUTPUT_SPECIES=$(( ${#CXR_OUTPUT_SPECIES_NAMES[@]} - 1 ))

################################################################################
# Options for extraction of NABEL station data
################################################################################

# We will write a small .pro file with this and
# load it using the @-notation

# The Coordinates are expressed in terms of grid cells
# of the 3rd Grid and needs to be changed if the grid definition changes

# How should we normalize the concentrations? (nabel, physical, none)
CXR_NORM_METHOD=none

# This is the IDL procedure for the extraction
# Because it is not executable, we treat it as an input file
CXR_STATION_PROC_INPUT_FILE=${CXR_POSTPROCESSOR_DAILY_INPUT_DIR}/extract_station_data/extract_arpa_stations.pro


# Entry 0 no dummy here!

# unset arrays first
unset CXR_STATION
unset CXR_STATION_X
unset CXR_STATION_Y

CXR_STATION[0]=basel
CXR_STATION_X[0]=44.62
CXR_STATION_Y[0]=73.26

CXR_STATION[1]=bern
CXR_STATION_X[1]=42.15
CXR_STATION_Y[1]=51.21

CXR_STATION[2]=chaumont
CXR_STATION_X[2]=30.34
CXR_STATION_Y[2]=54.34

CXR_STATION[3]=davos
CXR_STATION_X[3]=103.53
CXR_STATION_Y[3]=50.23

CXR_STATION[4]=duebendorf
CXR_STATION_X[4]=70.68
CXR_STATION_Y[4]=69.65

CXR_STATION[5]=haerkingen
CXR_STATION_X[5]=51.02
CXR_STATION_Y[5]=65.10

CXR_STATION[6]=jungfrau
CXR_STATION_X[6]=56.76
CXR_STATION_Y[6]=37.05

CXR_STATION[7]=laegern
CXR_STATION_X[7]=64.28
CXR_STATION_Y[7]=72.05

CXR_STATION[8]=lausanne
CXR_STATION_X[8]=22.55
CXR_STATION_Y[8]=34.43

CXR_STATION[9]=lugano
CXR_STATION_X[9]=82.88
CXR_STATION_Y[9]=18.78

CXR_STATION[10]=magadino
CXR_STATION_X[10]=81.90
CXR_STATION_Y[10]=24.27

CXR_STATION[11]=payerne
CXR_STATION_X[11]=29.85
CXR_STATION_Y[11]=45.54

CXR_STATION[12]=rigi
CXR_STATION_X[12]=67.73
CXR_STATION_Y[12]=57.02

CXR_STATION[13]=sion
CXR_STATION_X[13]=41.00
CXR_STATION_Y[13]=24.05

CXR_STATION[14]=taenikon
CXR_STATION_X[14]=77.78
CXR_STATION_Y[14]=72.99

CXR_STATION[15]=zurich
CXR_STATION_X[15]=68.66
CXR_STATION_Y[15]=68.52

# We count the number (do not change unless you know why)
CXR_NUMBER_OF_STATIONS=${#CXR_STATION[@]}

################################################################################
# The OPM and EXEC Settings are machine-dependent.
################################################################################ 
# Are we on a multicore system?
CXR_NUM_CORES=$(main.countCores)

# Maximal number of parallel processes in the CAMxRunner
if [[ "$CXR_PARALLEL_PROCESSING" == true  ]]
then
	# By default, use the number of cores
	CXR_MAX_PARALLEL_PROCS=$CXR_NUM_CORES
else
	# Non-Parallel use 1 process
	CXR_MAX_PARALLEL_PROCS=1
fi

# This can be either None, OMP or MPI (MPI is not currently implemented). OMP is recommended.
# the CAMx executable mifust provide this!
CXR_PARALLEL_PARADIGM=OMP

################################################################################
# OpenMP settings
################################################################################
# Switch on OMP
# If num_cores=1, OMP is turned off

# Number of CPUS
export NCPUS=$CXR_NUM_CORES

# Set number of OpenMP threads (usually equals CPU number)
export OMP_NUM_THREADS=$CXR_NUM_CORES

# Per Thread stack size. Can lead to problems if both to large or too small...
export MPSTKZ=128M

################################################################################
# Determine name of executable.
################################################################################

# If you need another executable name,
# set this value to a full path.
#CXR_MODEL_EXEC=/path/to/my/exec

################################################################################
# Debugging settings
################################################################################
# These function will always show verbose information:
CXR_LOG_FUNCTION_VERBOSE_LIST="common.parallel.Worker common.module.areDependenciesOk? common.parallel.mixTasks"
CXR_EVALUATE_FUNCTION_VERBOSE_LIST=true
