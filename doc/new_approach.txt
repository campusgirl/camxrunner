# Structure
CREATE TABLE DEPENDENCIES (independent_module, 
                           independent_day_offset, 
                           independent_invocation, 
                           dependent_module, 
                           dependent_day_offset, 
                           dependent_invocation);

# Fill days table depending on the number of days we run
...

# Create tasks by "joining" constants and days
# ONLY repeat this step if needed!!
# Using find to get files
for file in $(find)

	StoreMetadata (NumInvocations must not be stored)
		Modules
		Types
		Metadata
			Store each raw dependency on its own
	
	for invocation in ...
		# Insert Tasks
		INSERT INTO TASKS (module_name, invocation, day_offset) 
		SELECT 'create_emissions',1,offset from days
	done
	
done

# Now we need to determine the dependencies
# We have the raw dependencies in the metadata


## Sequential

	# (-) is irrelevant because we ensure the right temporal order anyway

	# OneTimePre
		# insert all tasks with all tasks (tsort needs this for stuff without dependency)
		INSERT INTO dependencies (independent_module,independent_day_offset,independent_invocation,dependent_module,dependent_day_offset,dependent_invocation)
		SELECT ta.module, ta.day_offset, ta.invocation,$curr_module,$curr_day_offset, $curr_invocation FROM tasks ta, types ty
		WHERE ta.module = ty.module
		  AND ty.type = '$currtype'
		      
		# Get the raw dependencies
		SELECT met.module, met.field, ta.day_offset, ta.invocation
		FROM metadata met, tasks ta, types ty
		WHERE met.module = ta.module
		  AND ty.module = met.module
		  AND ty.type = '$currtype'
		
		# Loop through result
		...
		
		# Get Unique list
		# Put it into the plan
		# delete dependencies
		
		
	# DailyPre, Model, DailyPost can be treated together
		# First, create list as above.
	
		# tsort the list
		# then create the cartesian product of this list with all days
		# Insert this into the plan table
		# delete dependencies
	
	# OneTimePost
		# Do analogous to OneTimePre


## Parallel

	# First of all, insert all tasks with all tasks (tsort needs this for stuff without dependency)
	# Any duplicates will be removed later.
	INSERT INTO dependencies (independent_module,independent_day_offset,independent_invocation,dependent_module,dependent_day_offset,dependent_invocation)
	SELECT module_name, day_offset, invocation,module_name, day_offset, invocation FROM tasks
	
	# Get the raw dependencies
	SELECT met.module, met.field, ta.day_offset, ta.invocation
	FROM metadata met, tasks ta
	WHERE met.module = ta.module
	
	# Loop through result
	# is it a all_*?
		# yes 
			# Minus?
				# Yes. Note that if nothing is found, nothing is returned.
				INSERT INTO dependencies (independent_module,independent_day_offset,independent_invocation,dependent_module,dependent_day_offset,dependent_invocation)
				SELECT ta.module, ta.day_offset, ta.invocation,$curr_module,$curr_day_offset, $curr_invocation FROM tasks ta, types ty
				WHERE ta.module = ty.module
				  AND ta.module=$curr_field
				  AND ty.type = '$currtype'
				  AND ta.day_offset = $curr_day_offset - 1
				
				#No
				INSERT INTO dependencies (independent_module,independent_day_offset,independent_invocation,dependent_module,dependent_day_offset,dependent_invocation)
				SELECT ta.module, ta.day_offset, ta.invocation,$curr_module,$curr_day_offset, $curr_invocation FROM tasks ta, types ty
				WHERE ta.module = ty.module
				  AND ta.module=$curr_field
				  AND ty.type = '$currtype'
				  AND ta.day_offset = $curr_day_offset
	
		# No, plain
			# Minus?
				# Yes. Note that if nothing is found, nothing is returned.
				INSERT INTO dependencies (independent_module,independent_day_offset,independent_invocation,dependent_module,dependent_day_offset,dependent_invocation)
				SELECT ta.module, ta.day_offset, ta.invocation,$curr_module,$curr_day_offset, $curr_invocation FROM tasks ta
				WHERE ta.module=$curr_field AND ta.day_offset = $curr_day_offset - 1
				
				#No
				INSERT INTO dependencies (independent_module,independent_day_offset,independent_invocation,dependent_module,dependent_day_offset,dependent_invocation)
				SELECT ta.module, ta.day_offset, ta.invocation,$curr_module,$curr_day_offset, $curr_invocation FROM tasks ta
				WHERE ta.module=$curr_field AND ta.day_offset = $curr_day_offset
				
	# Now, select the list out (distinct!) and sort it
	
	# Store this as a plan