		# DB Structure

		${CXR_SQLITE_EXEC} "$CXR_STATE_DB_FILE" <<-EOT
		-- Get exclusive access
		PRAGMA main.locking_mode=EXCLUSIVE; 
		
		-- Here we store all installed stuff (just for installer)
		CREATE TABLE IF NOT EXISTS installed (item,
		                                      model,
		                                      model_version);
		
		-- Here we store all known simulation days
		CREATE TABLE IF NOT EXISTS days (day_offset,
		                                 day_iso);
		
		-- These are the days we currently plan to run on
		CREATE TABLE IF NOT EXISTS plan_days (day_offset,
		                                      day_iso);

		-- All modules go here
		CREATE TABLE IF NOT EXISTS modules (module, 
		                                    type,
		                                    path);
		CREATE UNIQUE INDEX IF NOT EXISTS module_idx ON module(module);

		-- List of module types
		CREATE TABLE IF NOT EXISTS types (type);
		CREATE UNIQUE INDEX IF NOT EXISTS module_idx ON types(type);
		
		-- Storage of module metadata
		CREATE TABLE IF NOT EXISTS metadata (module,
		                                     field,
		                                     value);

		-- Table to store dependencies
		CREATE TABLE IF NOT EXISTS dependencies (independent_module, 
		                                         independent_day_offset, 
		                                         independent_invocation, 
		                                         dependent_module, 
		                                         dependent_day_offset, 
		                                         dependent_invocation);
		
		-- Table for all tasks comprising a run (static)
		CREATE TABLE IF NOT EXISTS tasks (module,
		                                 module_type,
		                                 exclusive,
		                                 day_offset,
		                                 invocation,
		                                 status,
		                                 epoch_m);
		                                 
		-- Table for all steps we need to take, ordered
		CREATE TABLE IF NOT EXISTS plan (id,
		                                 module,
		                                 module_type,
		                                 exclusive,
		                                 day_offset,
		                                 invocation,
		                                 status,
		                                 epoch_m);
		
		-- Table for workers
		CREATE TABLE IF NOT EXISTS workers (pid,
		                                    hostname,
		                                    status,
		                                    current_task,
		                                    epoch_m);
		
		PRAGMA main.locking_mode=NORMAL; 
		
		EOT


# Fill days table depending on the number of days we run
...

# Create tasks by "joining" constants and days
# ONLY repeat this step if needed!!
# Using find to get files
for file in $(find)

	StoreMetadata (NumInvocations must not be stored)
		Modules
		Types
		Metadata
			Store each raw dependency on its own
	
	for invocation in ...
		# Insert Tasks
		INSERT INTO TASKS (module, invocation, day_offset) 
		SELECT 'create_emissions',1,offset from days
	done
	
done

# Now we need to determine the dependencies
# We have the raw dependencies in the metadata


## Sequential

	# (-) is irrelevant because we ensure the right temporal order anyway

	# OneTimePre
		# insert all tasks with all tasks (tsort needs this for stuff without dependency)
		INSERT INTO dependencies (independent_module,independent_day_offset,independent_invocation,dependent_module,dependent_day_offset,dependent_invocation)
		SELECT ta.module, ta.day_offset, ta.invocation,$curr_module,$curr_day_offset, $curr_invocation FROM tasks ta, types ty
		WHERE ta.module = ty.module
		  AND ty.type = '$currtype'
		      
		# Get the raw dependencies
		SELECT met.module, met.field, ta.day_offset, ta.invocation
		FROM metadata met, tasks ta, types ty
		WHERE met.module = ta.module
		  AND ty.module = met.module
		  AND ty.type = '$currtype'
		
		# Loop through result
		...
		
		# Get Unique list
		# Put it into the plan
		# delete dependencies
		
		
	# DailyPre, Model, DailyPost can be treated together
		# First, create list as above.
	
		# tsort the list
		# then create the cartesian product of this list with all days
		# Insert this into the plan table
		# delete dependencies
	
	# OneTimePost
		# Do analogous to OneTimePre


## Parallel

	# First of all, insert all tasks with all tasks (tsort needs this for stuff without dependency)
	# Any duplicates will be removed later.
	INSERT INTO dependencies (independent_module,independent_day_offset,independent_invocation,dependent_module,dependent_day_offset,dependent_invocation)
	SELECT module, day_offset, invocation,module, day_offset, invocation FROM tasks
	
	# Get the raw dependencies
	SELECT met.module, met.field, ta.day_offset, ta.invocation
	FROM metadata met, tasks ta
	WHERE met.module = ta.module
	
	# Loop through result
	# is it a all_*?
		# yes 
			# Minus?
				# Yes. Note that if nothing is found, nothing is returned.
				INSERT INTO dependencies (independent_module,independent_day_offset,independent_invocation,dependent_module,dependent_day_offset,dependent_invocation)
				SELECT ta.module, ta.day_offset, ta.invocation,$curr_module,$curr_day_offset, $curr_invocation FROM tasks ta, types ty
				WHERE ta.module = ty.module
				  AND ta.module=$curr_field
				  AND ty.type = '$currtype'
				  AND ta.day_offset = $curr_day_offset - 1
				
				#No
				INSERT INTO dependencies (independent_module,independent_day_offset,independent_invocation,dependent_module,dependent_day_offset,dependent_invocation)
				SELECT ta.module, ta.day_offset, ta.invocation,$curr_module,$curr_day_offset, $curr_invocation FROM tasks ta, types ty
				WHERE ta.module = ty.module
				  AND ta.module=$curr_field
				  AND ty.type = '$currtype'
				  AND ta.day_offset = $curr_day_offset
	
		# No, plain
			# Minus?
				# Yes. Note that if nothing is found, nothing is returned.
				INSERT INTO dependencies (independent_module,independent_day_offset,independent_invocation,dependent_module,dependent_day_offset,dependent_invocation)
				SELECT ta.module, ta.day_offset, ta.invocation,$curr_module,$curr_day_offset, $curr_invocation FROM tasks ta
				WHERE ta.module=$curr_field AND ta.day_offset = $curr_day_offset - 1
				
				#No
				INSERT INTO dependencies (independent_module,independent_day_offset,independent_invocation,dependent_module,dependent_day_offset,dependent_invocation)
				SELECT ta.module, ta.day_offset, ta.invocation,$curr_module,$curr_day_offset, $curr_invocation FROM tasks ta
				WHERE ta.module=$curr_field AND ta.day_offset = $curr_day_offset
				
	# Now, select the list out (distinct!) and sort it
	
	# Store this as a plan